<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Th·ªëng k√™ & B√°o c√°o | CAFREE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f3f4f6; margin: 0; padding: 20px; }
        
        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .header h2 { margin: 0; color: #6a11cb; display: flex; align-items: center; gap: 10px; }
        .btn-back {
            text-decoration: none; background: #6a11cb; color: white;
            padding: 10px 20px; border-radius: 8px; font-weight: bold;
        }

        /* Filter Bar (Thanh l·ªçc th√°ng) */
        .filter-bar {
            background: white; padding: 15px 20px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
        }
        .filter-group { display: flex; align-items: center; gap: 10px; }
        input[type="month"] {
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
        }
        .btn-word {
            background: #2980b9; color: white; border: none; padding: 10px 15px;
            border-radius: 6px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-word:hover { background: #1c5980; }

        /* Dashboard Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: #27ae60; margin-top: 10px; }
        .stat-label { color: #666; font-size: 14px; }

        /* Table */
        .table-container {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #333; }
        tr:hover { background: #f1f1f1; }
        
        .btn-danger {
            background: #e74c3c; color: white; border: none;
            padding: 8px 12px; border-radius: 6px; cursor: pointer; width: 100%;
        }
    </style>
</head>
<body>

    <div class="header">
        <h2><i class="fa-solid fa-chart-pie"></i> B√ÅO C√ÅO DOANH THU</h2>
        <a href="Trang Ch·ªß.html" class="btn-back">‚¨Ö Quay l·∫°i B√°n h√†ng</a>
    </div>

    <div class="filter-bar">
        <div class="filter-group">
            <label style="font-weight:bold;">Ch·ªçn th√°ng:</label>
            <input type="month" id="monthPicker" onchange="loadData()">
        </div>

        <div style="flex:1"></div> 
        <button class="btn-word" onclick="exportToWord()">
            <i class="fa-solid fa-file-word"></i> Xu·∫•t B√°o C√°o (Word)
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">T·ªïng h√≥a ƒë∆°n (Th√°ng n√†y)</div>
            <div class="stat-value" id="totalCount">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">T·ªïng doanh thu (Th√°ng n√†y)</div>
            <div class="stat-value" id="totalRevenue">0 ƒë</div>
        </div>
        <div class="stat-card" style="padding: 10px;">
            <button class="btn-danger" onclick="clearData()" style="height:100%;">
                üóëÔ∏è X√≥a d·ªØ li·ªáu g·ªëc
            </button>
        </div>
    </div>

    <div class="table-container">
        <h3>Chi ti·∫øt h√≥a ƒë∆°n</h3>
        <table>
            <thead>
                <tr>
                    <th>M√£ Hƒê</th>
                    <th>Ng√†y gi·ªù</th>
                    <th>B√†n / Lo·∫°i</th>
                    <th>Ghi ch√∫</th> <th>T·ªïng ti·ªÅn</th>
                </tr>
            </thead>
            <tbody id="historyTable">
                </tbody>
        </table>
    </div>

    <script>
        // Khi t·∫£i trang: ƒê·∫∑t m·∫∑c ƒë·ªãnh l√† th√°ng hi·ªán t·∫°i v√† t·∫£i d·ªØ li·ªáu
        document.addEventListener("DOMContentLoaded", function() {
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); // L·∫•y d·∫°ng YYYY-MM
            document.getElementById("monthPicker").value = monthStr;
            
            loadData();
        });

        // Bi·∫øn to√†n c·ª•c l∆∞u d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã ƒë·ªÉ d√πng cho xu·∫•t b√°o c√°o
        let currentMonthData = [];
        let currentRevenue = 0;

        function loadData() {
            // 1. L·∫•y t·∫•t c·∫£ l·ªãch s·ª≠ (D√πng salesHistory cho ƒë·ªìng b·ªô v·ªõi trang B√°n h√†ng)
            let fullHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];
            
            // 2. L·∫•y th√°ng ng∆∞·ªùi d√πng ƒëang ch·ªçn (YYYY-MM)
            let selectedMonth = document.getElementById("monthPicker").value; 
            
            let tableBody = document.getElementById("historyTable");
            currentRevenue = 0;
            currentMonthData = []; // Reset d·ªØ li·ªáu t·∫°m

            tableBody.innerHTML = "";

            // 3. L·ªçc v√† hi·ªÉn th·ªã
            fullHistory.forEach(invoice => {
                // X·ª≠ l√Ω ng√†y th√°ng
                let parts = invoice.date.split('/'); // ["23", "12", "2025"]
                let invoiceMonth = "";
                if(parts.length === 3) {
                     invoiceMonth = `${parts[2]}-${parts[1]}`; // "2025-12"
                }

                // N·∫øu tr√πng kh·ªõp th√°ng ƒë√£ ch·ªçn
                if (invoiceMonth === selectedMonth) {
                    currentMonthData.push(invoice);
                    currentRevenue += invoice.total;

                    // T·∫°o h√†ng cho b·∫£ng
                    let row = `
                        <tr>
                            <td style="font-weight:bold; color:#6a11cb">${invoice.id || invoice.code}</td>
                            <td>${invoice.date} - ${invoice.time || ''}</td>
                            <td>
                                <span style="background:${invoice.table==='Mang v·ªÅ'?'#fff3cd':'#e8f5e9'}; padding:4px 8px; border-radius:4px;">
                                    ${invoice.table}
                                </span>
                            </td>
                            
                            <td style="color:#666; font-style:italic; max-width: 200px;">
                                ${invoice.note || ''}
                            </td>
                            
                            <td style="font-weight:bold;">${invoice.total.toLocaleString()} ƒë</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            });

            // 4. C·∫≠p nh·∫≠t s·ªë li·ªáu t·ªïng quan
            document.getElementById("totalCount").innerText = currentMonthData.length;
            document.getElementById("totalRevenue").innerText = currentRevenue.toLocaleString() + " ƒë";
        }

        // --- H√ÄM XU·∫§T FILE WORD ---
        function exportToWord() {
            if (currentMonthData.length === 0) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu trong th√°ng n√†y ƒë·ªÉ xu·∫•t b√°o c√°o!");
                return;
            }

            let monthVal = document.getElementById("monthPicker").value; 
            let [year, month] = monthVal.split("-");

            // T·∫°o n·ªôi dung HTML cho file Word
            let htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>B√°o c√°o doanh thu</title>
                <style>
                    body { font-family: 'Times New Roman', serif; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; text-align: center; font-weight: bold; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .total { margin-top: 20px; font-size: 18px; font-weight: bold; text-align: right; }
                </style>
                </head>
                <body>
                    <div class="header">
                        <h1 style="margin:0">C·ª¨A H√ÄNG CAFREE</h1>
                        <h2 style="margin:5px 0">B√ÅO C√ÅO DOANH THU</h2>
                        <p>Th√°ng ${month} nƒÉm ${year}</p>
                    </div>

                    <p><strong>Ng√†y xu·∫•t:</strong> ${new Date().toLocaleString('vi-VN')}</p>
                    <p><strong>T·ªïng s·ªë h√≥a ƒë∆°n:</strong> ${currentMonthData.length}</p>

                    <table>
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>M√£ Hƒê</th>
                                <th>Ng√†y gi·ªù</th>
                                <th>B√†n</th>
                                <th>Ghi ch√∫</th> 
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // V√≤ng l·∫∑p th√™m t·ª´ng d√≤ng d·ªØ li·ªáu v√†o b·∫£ng Word
            currentMonthData.forEach((inv, index) => {
                htmlContent += `
                    <tr>
                        <td style="text-align:center">${index + 1}</td>
                        <td>${inv.id || inv.code}</td>
                        <td>${inv.date} ${inv.time || ''}</td>
                        <td>${inv.table}</td>
                        <td>${inv.note || ''}</td>
                        <td style="text-align:right">${inv.total.toLocaleString()} ƒë</td>
                    </tr>
                `;
            });

            // K·∫øt th√∫c b·∫£ng v√† th√™m t·ªïng ti·ªÅn
            htmlContent += `
                        </tbody>
                    </table>
                    
                    <div class="total">
                        T·ªîNG DOANH THU: ${currentRevenue.toLocaleString()} VNƒê
                    </div>
                    
                    <br><br>
                    <div style="display:flex; justify-content:space-between; margin-top:50px">
                        <div style="text-align:center; width:40%; float:left">
                            <strong>Ng∆∞·ªùi l·∫≠p bi·ªÉu</strong><br>
                            (K√Ω, h·ªç t√™n)
                        </div>
                        <div style="text-align:center; width:40%; float:right">
                            <strong>Qu·∫£n l√Ω x√°c nh·∫≠n</strong><br>
                            (K√Ω, h·ªç t√™n)
                        </div>
                    </div>
                </body>
                </html>
            `;

            // T·∫°o file Blob v√† t·∫£i v·ªÅ
            let blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword'
            });
            
            let url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(htmlContent);
            
            let downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);
            
            if(navigator.msSaveOrOpenBlob ){
                navigator.msSaveOrOpenBlob(blob, `Bao_cao_doanh_thu_${month}_${year}.doc`);
            } else {
                downloadLink.href = url;
                downloadLink.download = `Bao_cao_doanh_thu_${month}_${year}.doc`;
                downloadLink.click();
            }
            
            document.body.removeChild(downloadLink);
        }

        function clearData() {
            if (confirm("C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA S·∫†CH to√†n b·ªô d·ªØ li·ªáu b√°n h√†ng kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
                // ƒê√É S·ª¨A: D√πng salesHistory ƒë·ªÉ x√≥a ƒë√∫ng d·ªØ li·ªáu
                localStorage.removeItem('salesHistory'); 
                loadData();
                alert("ƒê√£ x√≥a d·ªØ li·ªáu g·ªëc!");
            }
        }
    </script>

</body>
</html>
